# ALLMA Project - Lessons Learned & Error Log

> **Purpose:** This document records critical errors, their root causes, and the specific protocols implemented to prevent them from happening again.
> **Rule:** Before starting a complex task, review this log to ensure past mistakes are not repeated.

## 2026-01-16: Build 153 Crash & Deployment Failures

### 1. The Truncated `main.py`
*   **Error:** The application crashed immediately on startup (open & close).
*   **Root Cause:** The `inject_blob.py` script (or manual editing) replaced the `ZIP_DATA` variable but inadvertently deleted or failed to append the execution logic (Kivy App class and `if __name__` block).
*   **Lesson:** Never assume a file is correct just because it exists.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 1: Verify `main.py` has the footer code (> 150 lines).

### 5. API Signature Mismatch
*   **Error:** The Chat UI called `core.process_message(text, context)` but the Core expected `(user_id, conv_id, text)`. Result: `TypeError`.
*   **Root Cause:** The UI code was written based on an outdated or assumed API signature of `AllmaCore`.
*   **Lesson:** When reconnecting detached components (UI + Core), verify method signatures match exactly.
### 6. Fallback Logic Robustness
*   **Error:** The App echoed inputs because the fallback mechanism (TopicExtractor) crashed on a type error (`numpy` vs `scipy` sparse), causing a "double failure".
*   **Root Cause:** Assuming a library (`SimpleTfidf`) returns a specific type (sparse matrix) without checking, in an environment (Android) where implementations might differ or fail.
*   **Lesson:** Fallback logic must be bulletproof. If the fallback crashes, the app looks broken.
### 7. Code Editing Precision
*   **Error:** In Build 157, I deleted a method signature (`def _generate_balanced_response`) while replacing its body, causing an `AttributeError` at runtime.
*   **Root Cause:** Improper selection of `TargetContent` vs `ReplacementContent` in the `replace_file_content` tool. I matched the def line but didn't put it back.
*   **Lesson:** ALWAYS read the code after an edit. Using `view_file` immediately after a write is mandatory for complex replacements.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 7: Verify syntax/structure of modified files (functions must have `def`).

### 2. Missing "Internal" Components
*   **Error:** Build 153.1 would have failed because it tried to import `SetupView` and `ChatView` which did not exist in the `allma_model` directory being zipped.
*   **Root Cause:** Focused entirely on fixing the "Container" (`main.py`) without verifying the "Content" (`allma_model` source code).
*   **Lesson:** Fixing the delivery mechanism (zip extraction) is useless if the payload is empty.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 2: Explicitly verify `ui/setup_view.py` and `ui/chat_view.py` exist before zipping.

### 3. Model Filename Sync Failure
*   **Error:** The Downloader was set to download `Gemma-3n`, but the LLM Wrapper was hardcoded to look for `Gemma-2`.
*   **Root Cause:** Changing a dependency (Model Version) in one place (`ModelDownloader`) without updating its consumer (`MobileGemmaWrapper`).
*   **Lesson:** Configuration parameters (filenames, versions, APIs) must be defined in a single shared place or explicitly synced.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 3: Verify filename consistency between Downloader and Wrapper.

---
### Lesson 8: The Cross-Compilation Saga (Builds 160-166)
**Issue:** `llama-cpp-python` failed to compile for Android with `clang-14: error: ... -march=native`.
**Root Cause:** The upstream library hardcodes `-march=native` (optimization for host CPU), which breaks when cross-compiling for ARM64 Android.
**Failed Attempts:**
- B161-164: Trying to `sed` replace the flag on source code from GitHub URL. Failed because GitHub tarballs excluded the `vendor/` submodule (empty dirs).
**Successful Strategy (Hypothesis):**
1.  **Source:** Switch to PyPI sdist (`files.pythonhosted.org`) which bundles all submodules.
2.  **Patching:** Instead of complex regex replacement, **append** a corrective block to the end of `CMakeLists.txt` to override previous flags (`string(REPLACE "-march=native" "" ...)`).
**Learning:** When compiling complex C++ libs, always use PyPI sources (not GitHub autogenerated ones) and prefer "Append Overrides" over "Search & Replace".

---
*End of Log*

---
### Lesson 9: The Stale Build Artifact Trap (Build 177)
**Issue:** Changes to Python source code in `buildozer.spec` or recipes were ignored in the APK, causing the app to run old code and misleading debugging efforts.
**Root Cause:** `python-for-android` aggressively caches build outcomes (`dists`, `python-installs`) and does not re-copy Python source files unless the requirement version changes or a clean build is forced.
**Detection:** Logs showed `n_batch=256` (old code) vs `n_batch=1` (new code on disk).
**Solution:**
1.  **Stop Assuming:** When code changes don't appear, assume stale cache.
2.  **Clean Command:** Run `rm -rf .buildozer/android/platform/build-*/dists` AND `rm -rf .buildozer/android/platform/build-*/build/python-installs` before rebuilding critical logic.
3.  **Future:** Use `p4a clean_dists` or simply delete the specific dist folder.
