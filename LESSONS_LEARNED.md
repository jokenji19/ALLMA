# ALLMA Project - Lessons Learned & Error Log

> **Purpose:** This document records critical errors, their root causes, and the specific protocols implemented to prevent them from happening again.
> **Rule:** Before starting a complex task, review this log to ensure past mistakes are not repeated.

## 2026-01-16: Build 153 Crash & Deployment Failures

### 1. The Truncated `main.py`
*   **Error:** The application crashed immediately on startup (open & close).
*   **Root Cause:** The `inject_blob.py` script (or manual editing) replaced the `ZIP_DATA` variable but inadvertently deleted or failed to append the execution logic (Kivy App class and `if __name__` block).
*   **Lesson:** Never assume a file is correct just because it exists.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 1: Verify `main.py` has the footer code (> 150 lines).

### 5. API Signature Mismatch
*   **Error:** The Chat UI called `core.process_message(text, context)` but the Core expected `(user_id, conv_id, text)`. Result: `TypeError`.
*   **Root Cause:** The UI code was written based on an outdated or assumed API signature of `AllmaCore`.
*   **Lesson:** When reconnecting detached components (UI + Core), verify method signatures match exactly.
### 6. Fallback Logic Robustness
*   **Error:** The App echoed inputs because the fallback mechanism (TopicExtractor) crashed on a type error (`numpy` vs `scipy` sparse), causing a "double failure".
*   **Root Cause:** Assuming a library (`SimpleTfidf`) returns a specific type (sparse matrix) without checking, in an environment (Android) where implementations might differ or fail.
*   **Lesson:** Fallback logic must be bulletproof. If the fallback crashes, the app looks broken.
### 7. Code Editing Precision
*   **Error:** In Build 157, I deleted a method signature (`def _generate_balanced_response`) while replacing its body, causing an `AttributeError` at runtime.
*   **Root Cause:** Improper selection of `TargetContent` vs `ReplacementContent` in the `replace_file_content` tool. I matched the def line but didn't put it back.
*   **Lesson:** ALWAYS read the code after an edit. Using `view_file` immediately after a write is mandatory for complex replacements.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 7: Verify syntax/structure of modified files (functions must have `def`).

### 2. Missing "Internal" Components
*   **Error:** Build 153.1 would have failed because it tried to import `SetupView` and `ChatView` which did not exist in the `allma_model` directory being zipped.
*   **Root Cause:** Focused entirely on fixing the "Container" (`main.py`) without verifying the "Content" (`allma_model` source code).
*   **Lesson:** Fixing the delivery mechanism (zip extraction) is useless if the payload is empty.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 2: Explicitly verify `ui/setup_view.py` and `ui/chat_view.py` exist before zipping.

### 3. Model Filename Sync Failure
*   **Error:** The Downloader was set to download `Gemma-3n`, but the LLM Wrapper was hardcoded to look for `Gemma-2`.
*   **Root Cause:** Changing a dependency (Model Version) in one place (`ModelDownloader`) without updating its consumer (`MobileGemmaWrapper`).
*   **Lesson:** Configuration parameters (filenames, versions, APIs) must be defined in a single shared place or explicitly synced.
*   **Prevention:** `QA_CHECKLIST.md` -> Check 3: Verify filename consistency between Downloader and Wrapper.

---
### Lesson 8: The Cross-Compilation Saga (Builds 160-166)
**Issue:** `llama-cpp-python` failed to compile for Android with `clang-14: error: ... -march=native`.
**Root Cause:** The upstream library hardcodes `-march=native` (optimization for host CPU), which breaks when cross-compiling for ARM64 Android.
**Failed Attempts:**
- B161-164: Trying to `sed` replace the flag on source code from GitHub URL. Failed because GitHub tarballs excluded the `vendor/` submodule (empty dirs).
**Successful Strategy (Hypothesis):**
1.  **Source:** Switch to PyPI sdist (`files.pythonhosted.org`) which bundles all submodules.
2.  **Patching:** Instead of complex regex replacement, **append** a corrective block to the end of `CMakeLists.txt` to override previous flags (`string(REPLACE "-march=native" "" ...)`).
**Learning:** When compiling complex C++ libs, always use PyPI sources (not GitHub autogenerated ones) and prefer "Append Overrides" over "Search & Replace".

---
### Lesson 9: The Stale Build Artifact Trap (Build 177)
**Issue:** Changes to Python source code were not being reflected in the deployed app.
**Root Cause:** `python-for-android` aggressively caches build outcomes (`dists`, `python-installs`) and does not re-copy Python source files unless the requirement version changes or a clean build is forced.
**Detection:** Logs showed `n_batch=256` (old code) vs `n_batch=1` (new code on disk).
**Solution:**
9.  **ALWAYS** use `buildozer android clean` or at least `buildozer android debug` when changing libraries or recipes. `deploy run` alone skips the build step and re-deploys the OLD APK.
10. **Library Wrappers vs. Environment Variables**: If you manually load a library in `main.py` and set an environment variable (like `LLAMA_CPP_LIB`), ensure the library's Python wrapper (e.g., `llama_cpp`) checks that variable *before* trying its own hardcoded search paths. Otherwise, it effectively ignores your successful bootstrap loading.

### Lesson 10: The Phantom Library (Packaging Native Libs)
**Problem:** Even if a recipe compiles a `.so` library correctly, Buildozer might not automatically package it into the APK if it's not in a standard location or explicitly included.
**Symptoms:** `OSError: Shared library ... not found` at runtime, even though the build succeeded.
**Solution:**
1.  **Manual Injection:** Copy the compiled `.so` (found in `.buildozer/.../build-lib-arm64/`) directly to the project root.
2.  **Explicit Config:** Add `so` to `source.include_exts` in `buildozer.spec`.
3.  **Pre-load:** Use `ctypes.CDLL("./libname.so")` in `main.py` to force loading before any sub-modules try to access it.

### Lesson 11: The WebView Asset Caching Trap (v0.16 Crash)
**Issue:** Added `?v=0.16` to CSS links to bust cache.
**Root Cause:** Android WebView's file system loader interprets `style.css?v=0.16` as a literal filename, failing to find the file `style.css` because looking for `style.css?v=0.16` on disk fails.
**Solution:** Do not use query parameters for local file assets in Android WebView. Rename the physical files (e.g., `style_v17.css`) if cache busting is strictly required, or rely on `clearCache(True)`.

### Lesson 12: CSS Opacity & Logic Safety (v0.18-v0.19)
**Issue:** User reported "Missing Timer/Icon" even though code was correct.
**Root Cause:** The element was created correctly in DOM but had `.generation-timer { opacity: 0 }` in CSS, waiting for a `.visible` class that was only added at the *end* of the process.
**Lesson:** When debugging "missing elements", always check CSS visibility/opacity states, not just DOM existence. Default state should often be visible for loading indicators.
### Lesson 13: The Mobile Keyboard Overlap (v0.20-v0.24)
**Issue:** Fixed-position input bars (`position: fixed; bottom: 0`) are notoriously unreliable on Android WebViews, often being covered by the virtual keyboard or detaching from the bottom.
**Failed Solution:** `window.visualViewport` + manual offsets. Unreliable timing and "jumpy" behavior.
**Winning Solution:** **Flexbox Layout**.
1.  Make `body` a flex container (`height: 100vh; flex-direction: column`).
2.  Make the content area fill space (`flex: 1`).
3.  Make the input area a standard block element (`position: relative`).
4.  Ensure `android.softinput_mode = adjustResize` in `buildozer.spec`.
**Result:** When the keyboard opens, the viewport shrinks, the body resizes, and the input bar (being part of the flow) stays visible naturally.

### Lesson 14: Network-Dependent Icons (v0.18)
**Issue:** `ion-icon` failed to load in offline/cached scenarios, leaving the generation timer invisible.
**Lesson:** For critical UI elements (like loading spinners), use **Inline SVGs** or pure text/CSS solutions. Do not rely on external scripts (CDN) or even complex local asset loading if the element's presence is vital for UX. Text-based fallbacks (e.g., "âš¡") are bulletproof.

---
### Lesson 15: The Lamp Logic (Speed + Aesthetics) (Build 180+)
**Goal:** Maintain instantaneous streaming speed while visually separating "Think" (Lamp UI) from "Say" (Chat Bubble).
**Failed Approach:** Wait for full thought generation before streaming, or using distinct API calls. Result: Too slow.
**Winning Solution:** **Single Stream with Client-Side Parsing**.
1.  **Python:** Force-inject `[[PENSIERO:` at the start of the stream.
2.  **JS:** `window.streamChunk` detects the tag. If found, it flips a switch (`isThinking = true`) and routes subsequent text to `.reasoning-container`.
3.  **Completion:** When `]]` arrives, the switch flips back, and text routes to `.chat-bubble`.
**Outcome:** User perceives 0ms latency in "starting to think", and the separation is purely visual. No backend orchestration delay.
**Key Fixing Point:** Duplicates of `[[PENSIERO:` must be aggressively stripped in JS to prevent recursion if the model retries.

### Lesson 16: Symbiotic Prompt Leaks (The "Silent Answer")
**Issue:** When falling back to the Symbiotic/Legacy path, the user saw either system instructions ("Stato emotivo...") or nothing at all.
**Root Cause:**
1.  **Leak:** The prompt lacked clean separators (`\n\n`) between the injected context block and the user instruction.
2.  **Silence:** The fallback generator (`response_generator.py`) created a static string but the `stream_callback` was never invoked, so the UI (expecting a stream) showed nothing.
**Solution:**
1.  **Separation:** Enforce strict double-newline separation in prompt assembly.
2.  **Manual Stream:** If falling back to static generation, **manually invoke** `stream_callback` chunk-by-chunk in a loop to simulate streaming. This ensures the UI state machine (Thinking -> Speaking) completes correctly.

### Lesson 17: Compiling llama.cpp 0.3.16 for Android (The Phtread & CURL Saga)
**Goal:** Upgrade `llama.cpp` to support newer models (Qwen 3 / 2.5).
**Obstacles:**
1.  **Linker Error (`-lpthread`):** Android puts pthreads in libc, but `llama.cpp` CMake scripts insist on linking `-lpthread` or `-lpthreads`.
    - **Fix 1 (Failed):** Patching just `common/CMakeLists.txt`.
    - **Fix 2 (Winning):** **Global Recursive Patch** of ALL `CMakeLists.txt` to replace `find_package(Threads REQUIRED)` with a custom Android block (`add_library(Threads::Threads INTERFACE IMPORTED)`).
    - **Fix 3 (Nuclear):** Forcing CMake Cache variables (`-DCMAKE_HAVE_LIBC_PTHREAD=1`, `-DCMAKE_THREAD_LIBS_INIT=""`) to bypass internal checks.
2.  **Missing Dependency (`CURL`):** Newer `llama.cpp` enables `LLAMA_CURL` by default. Android NDK doesn't have it.
    - **Fix:** Explicitly pass `-DLLAMA_CURL=OFF` to CMake.
3.  **Environment Conflict:** `buildozer.spec` had stale `env_vars` forcing `-DGGML_OPENMP=ON`, which overrode recipe settings and caused linking errors.
    - **Fix:** Cleaned `buildozer.spec` to let the recipe control flags.
**Outcome:** Compiled `libllama.so` succesfully!
